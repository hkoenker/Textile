---
author: "Hannah Koenker, Tropical Health"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    toc: TRUE
    toc_depth: 2
    toc_float: TRUE
    number_sections: TRUE
    fig_width: 6
    fig_height: 4
header-includes:
  - \usepackage{titling}
  - \predate{\begin{center}\large}
  - \postdate{\\
      \includegraphics[width=2in]{images/TH_logo.jpg}\end{center}}
mainfont: "Times New Roman"
monofont: "Monaco"
params: 
  country: Benin # default
  netfile: BJHR71_netfile.dta # default
title: "Analysis Approach for Assessing Textile Preferences on Net Use: `r params$country`"
editor_options:
  chunk_output_type: console
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(include = TRUE)
library(tidyverse)
library(janitor)
library(haven)
library(survey)
# install.packages("srvyr")
library(srvyr)
library(labelled)
library(flextable)
library(gtsummary)
library(lme4)
library(jtools)
library(ggstance)
library(dotwhisker)
library(tinylabels)
theme_set(theme_classic())

# The main title of the document won’t be translated here, but we can include a heading for each tab which will be translated. To achieve this we need to use HTML heading tags e.g. <h1> as if we try to use standard R Markdown # this will break the tabbing.
```

```{r}
country <- params$country
netfile <- params$netfile
```


```{r color-setup}
brandpal <- c("PermaNet" = "#5587C9", "Olyset" = "#C5362F", "Interceptor" = "pink", "Interceptor G2" = "deeppink", "unknown"="#A9A9A9", "Royal Sentry" = "#55896f", "Duranet" = "#00A9E0", "Serena" = "#5587C9", "NetProtect" = "cadetblue", "missing" = "WhiteSmoke",  "DawaPlus" = "darkseagreen", "Tsara" = "lightsteelblue", "Yorkool" = "lightgreen", "MagNet" = "limegreen", "Royal Guard" = "forestgreen", "Veeralin" = "navy")

textpal <- c(polyester = "#a6cee3", polyethylene = "#1f78b4", unknown = "#A9A9A9")
```

```{r read}
df <- read_dta(paste0("/Users/hannahkoenker/Dropbox/A DHS MIS Datasets/Analysis/Textile/",netfile)) %>% 
  clean_names() %>% 
  drop_na(netused, netsupply) %>% 
  # change 1: convert haven_labelled variables to factors ----
   mutate_if(haven::is.labelled, haven::as_factor) %>% 
  # change 2: convert variable labels to variable names ----
  #sjlabelled::label_to_colnames() %>% 
 # set_value_labels(textile = c("Polyester" = 1, "Polyethylene" = 2, "Polypropylene" = 3, "Unknown" = 4)) %>% 
  mutate(wt = hv005/1000000,
         netu = as.numeric(netused),
         netu = netu-1) 

# rename factor level here, if using mutate it will convert to character, no thanks.
levels(df$hv024) <- gsub('[^ -~]', 'e', levels(df$hv024)) 
levels(df$lbrand) <- gsub('[^ -~]', 'e', levels(df$lbrand)) 


cty <- df$dataset[1]

```


---
title: "Analysis Approach for Assessing Textile Preferences on Net Use: `r params$country`"
---

# Language {.tabset .tabset-dropdown}

## English

<h1>"Analysis Approach for Assessing Textile Preferences on Net Use: `r params$country`"</h1>

Insecticide-treated nets are the cornerstone of malaria control efforts worldwide. Over 2 billion ITNs have been distributed to people at risk of malaria over the past two decades. While most ITNs are used for malaria prevention, some gaps in use remain. Anecdotal reports and qualitative observations have indicated that in some areas, households may prefer softer polyester ITNs to ITNs made of polyethylene, which can have a 'harder' feel. 

As a result, National Malaria Control Programs have expressed a desire to procure only ITNs of a specific textile for upcoming mass distribution campaigns. While the Global Fund procurement system allows for these types of requests, they are unable to guarantee that nets of a particular textile will be available for a specific campaign, due to global supply chain issues, ITN production timelines, and other manufacturing variables. 

The Global Fund and WHO have advised countries wishing to procure nets of a single textile that this decision must be justified with data that support a significant increase in overall ITN use for one textile over another. 

This document aims to provide an analysis framework for use by National Malaria Control Programs and their partners wishing to demonstrate differential use of ITNs due to the textile of the net, in order to justify procurement of ITNs of a specific textile (polyester or polyethylene).

<h1> Summary of Analysis Approach</h1>

1.  Assess availability of data for analysis, including 
    - completeness of brand information, in order to determine the textile
    - ITN use outcome variable, at the net level
    - covariates associated with ITN use, including region, socioeconomic status, rural/urban, month of the year (for seasonal variations), age of the net, and whether the household has sufficient or insufficient ITNs for their family size.
2.  Determine whether existing data is sufficient for assessing the impact of textile on ITN use
    - assess whether both textiles are sufficiently represented in the data - minimum of 80/20 split
3.  If yes -- proceed with analysis
    - assess associations between ITN use and textile, along with other covariates, first in a univariate model
    - and then in a multivariate model, ideally accounting for clustering within the household
    - if the programmatic differences in ITN use by textile are significant, and the multivariate model shows a significant association between ITN use and textile controlling for covariates, there may be a justification for procurement of a single textile.
4.  If data are not sufficient -- recommendations for next steps
    - if data are incomplete -> collect complete data in the next survey
    - if one textile dominates the sample -> ensure a mix of textile types are distributed in the next campaign, then reassess
    
<h1> Analysis Approach</h1>

<h2> Assess availability and suitability of data for the analysis</h2>

1.  Download datasets for the most recent MIS or DHS or MICS from dhsprogram.com or mics.unicef.org

2.  If using an MIS or DHS, the ITN roster data are contained within the household file (files ending with HR). This file must be reshaped to long format, generating a dataset with one row for each net in the household. MICS datasets have a separate ITN file (TN).

3.  The outcome variable will be whether the ITN was used the previous night.

4.  Many household-level factors influence ITN use, and must be controlled for in the analysis. These variables are nearly always standard within MIS/DHS/MICS:

    -   region

    -   time of year (month of the survey)

    -   urban/rural setting

    -   socioeconomic status

    -   age of the net

    -   the number of nets and people within the household - frequently categorized as household owning

        -   'too few' ITNs,
        -   'just right' number of ITNs, or
        -   'too many' ITNs
        
Let us first review overall net use patterns across these covariates, to get a sense of what is happening in `r cty`. 

<h3>Region</h3>

```{r totaluse}

survey_design <-  df %>%
  as_survey_design(ids = hv001, strata = hv024, weights = hv005)

syv2 <-  survey_design %>% 
  group_by(hv024) %>% 
  summarize(netused = survey_mean(netu))

pnet <- function(column) {
  column <- sym(column)
  survey_design %>%
    group_by(!!column) %>%
    summarise(m = round(survey_mean(netu) * 100, 1)) %>%
    ggplot(aes(
      y = m,
      x = !!column,
      fill = ""
    )) +
    geom_col() +
    scale_fill_brewer(palette = "Set2") +
    geom_text(aes(label = m, vjust = -0.5)) +
    labs(
      y =  "",
      x =  "",
      fill =  "",
      title =  "Percentage of nets used"
    ) +
    scale_y_continuous(limits = c(0, 100)) +
    theme(legend.position = "none") 
}

```

``` {r regionuse}
pnet("hv024") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```
    


## French

<h1>"Canevas d'analyse pour evaluer l'association entre des preferences du tissu et l''utilisation des moustiquaires impregnées d'insecticide: `r params$country`"</h1>

Les moustiquaires imprégnées d'insecticide sont le premier outil des efforts de lutte contre le paludisme dans le monde. Plus de 2 milliards de MII ont été distribuées aux personnes à risque de paludisme au cours des deux dernières décennies. Alors que la plupart des MII sont utilisées pour la prévention du paludisme, certaines lacunes subsistent dans leur utilisation. Des rapports anecdotiques et des observations qualitatives ont indiqué que dans certaines endroits, les ménages peuvent préférer les MII en polyester plus souples aux MII en polyéthylène, qui peuvent avoir un toucher « plus dur ».

En conséquence, les programmes nationaux de lutte contre le paludisme ont exprimé le souhait de se procurer uniquement des MII d'un textile spécifique pour les prochaines campagnes de distribution de masse. Bien que le système d'approvisionnement du Fonds mondial autorise ce type de demandes, il ne peut garantir que les moustiquaires d'un textile particulier seront disponibles pour une campagne spécifique, en raison de problèmes liés à la chaîne d'approvisionnement mondiale, aux délais de production des MII et à d'autres variables de fabrication.

Le Fonds mondial et l'OMS ont informé les pays souhaitant acheter des moustiquaires d'un seul textile que cette décision doit être justifiée par des données qui soutiennent une augmentation significative de l'utilisation globale des MII pour un textile par rapport à un autre.

Ce document vise à fournir un cadre d'analyse à l'usage des Programmes Nationaux de Lutte contre le Paludisme et leurs partenaires souhaitant démontrer l'utilisation différentielle des MII en raison du textile de la moustiquaire, afin de justifier l'achat de MII d'un textile spécifique (polyester ou polyéthylène).

<h1> Résumé de l'approche d'analyse</h1>

1. Évaluer la disponibilité des données pour l'analyse, y compris
    - exhaustivité des informations sur la marque, afin de déterminer le textile
    - ITN utilise la variable de résultat, au niveau net
    - les covariables associées à l'utilisation des MII, y compris la région, le statut socio-économique, rural/urbain, le mois de l'année (pour les variations saisonnières), l'âge de la moustiquaire et si le ménage dispose de MII suffisantes ou insuffisantes pour la taille de sa famille.
2. Déterminer si les données existantes sont suffisantes pour évaluer l'impact du textile sur l'utilisation des MII
    - évaluer si les deux textiles sont suffisamment représentés dans les données - minimum de répartition 80/20
3. Si oui -- procéder à l'analyse
    - évaluer les associations entre l'utilisation des MII et le textile, ainsi que d'autres covariables, d'abord dans un modèle univarié
    - puis dans un modèle multivarié, prenant en compte idéalement le clustering au sein du ménage
    - si les différences programmatiques dans l'utilisation des MII par textile sont significatives et que le modèle multivarié montre une association significative entre l'utilisation des MII et le textile en contrôlant les covariables, il peut y avoir une justification pour l'achat d'un seul textile.
4. Si les données ne sont pas suffisantes -- recommandations pour les prochaines étapes
    - si les données sont incomplètes -> collecter des données complètes dans la prochaine enquête
    - si un textile domine l'échantillon -> assurez-vous qu'un mélange de types de textiles est distribué dans la prochaine campagne, puis réévaluez
    
<h1> Approche d'analyse</h1>

<h2> Évaluer la disponibilité et la pertinence des données pour l'analyse</h2>

1. Téléchargez les ensembles de données pour le MIS ou le DHS ou le MICS le plus récent sur dhsprogram.com ou mics.unicef.org

2. Si vous utilisez un MIS ou une EDS, les données de la liste des MII sont contenues dans le fichier des ménages (fichiers se terminant par HR). Ce fichier doit être remodelé au format long, générant un ensemble de données avec une ligne pour chaque moustiquaire dans le ménage. Les ensembles de données MICS ont un fichier MII (TN) distinct.

3. La variable de résultat sera de savoir si la MII a été utilisée la nuit précédente.

4. De nombreux facteurs au niveau des ménages influencent l'utilisation des MII et doivent être pris en compte dans l'analyse. Ces variables sont presque toujours standard dans MIS/DHS/MICS :

    - Région

    - Période de l'année (mois de l'enquête)

    - Milieu urbain/rural

    - Statut socioéconomique

    - Age de la MII

    - Le nombre de moustiquaires et de personnes au sein du ménage - fréquemment classées comme propriétaires du ménage

        - «trop peu» de MII,
        - le nombre «juste» de MII, ou
        - «trop» de MII
        
Examinons d'abord les modèles globaux d'utilisation du net à travers ces covariables, pour avoir une idée de ce qui se passe dans «`r cty`.

<h3>Region</h3>

``` {r regionuse}
pnet("hv024") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```
 